#!/usr/bin/env python3
import nmap
import json
from passComand import passCommand, printReport, writeReport, codeFunction

def scanVulnNmap(ip):
    code="nmap -n -Pn -p- -sV -O -script vuln "+ip
    codeFunction(code,'nmap_vulns',ip)
    

def scanNmap(ip):
    # Scan of the ip with nmap
    nm = nmap.PortScanner()

    host = ip
    results = nm.scan(ip, arguments="-sT -n -Pn -T4")

    puertosAbiertos = "-p "
    contador = 0
    print("++++++++++++++++++++++++++++++++\nRaw Print:\n")
    print(results)

    print('++++++++++++++++++++++++++++++++')
    print("Host : %s" % host)
    print("State : %s" % nm[host].state())
    for proto in nm[host].all_protocols():
        print("Protocol : %s" % proto)
        lport = nm[host][proto].keys()
        sorted(lport)
        for port in lport:
            print('port : %s\tstate : %s' %(port, nm[host][proto][port]['state']))
            if contador == 0:
                puertosAbiertos = puertosAbiertos+" "+str(port)
                contador = 1
            else:
                puertosAbiertos = puertosAbiertos+","+str(port)

        print("\nPuertos abiertos: "+puertosAbiertos+" IP:"+str(host))
        printReport("\nPuertos abiertos: "+puertosAbiertos+" IP:"+str(host),'nmap',host)
